---
title: "Bicycle Theft Report"
subtitle: "What is the scope of bike theft in Toronto over the past few years?"
author: "Chris Yan 1009096746, Aaron Dong 1008961232, Armaan Rehman Shah 1009641309"
date: "2023-04-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
# Importing the dataset
origin <- read.csv("bicycle.csv")
```

```{r, include=FALSE}
# Initiating libraries
library(tidyverse)
library(ggplot2)
library(ggmap)
library(png)
library(ggpubr)
library(osmdata)
library(gganimate)
library(scales)
library(dplyr)
library(stringr)
```

## Introduction

  The report concerns with the data "Bicycle Thefts Open Data" which contains occurrences related to bicycle thefts reported to the Toronto Police Service. These occurrences are related to a variety of offences where the theft of a bicycle was included. We obtained this dataset from the City of Toronto Open Data portal. It records all of the bike thefts in Toronto starting from as early as 2013. The dataset is published by the Toronto Police services and is refreshed annually all the way up until 2022. The dataset contains large amount of entries and multiple information variables.
\

### Purpose
The purpose of our report is to inform the public about the bike safety concerns in Toronto and its surrounding areas with regards to the precedence of stolen bikes in certain areas. We want to make it known in our report that the public should avoid parking bikes in hot-spots where bikes are often stolen. A map of the density of the stolen bike occurrences will show the precise locations where one should avoid leaving their bike. With our research we hope to provide a thorough investigation into these hot-spots and also provide such information of stolen bike occurrences to the Toronto Police.
\pagebreak

### Dataset Description

* __entry id named X_id__
  * unique entry id in increasing order
  * _integer_
* __event id named event_unique_id__
  * unique event id not sorted
  * _string_
* __offense committed named Primary_Offense__
  * type of crime that is committed
  * _string_
* __offense occurrence date named Occurrence_Date__
  * date of when the crime was committed
  * _string_
* __offense occurrence year named Occurrence_Year__
  * year of when the crime was committed
  * _integer_
* __offense occurrence month named Occurrence_Month__
  * month of when the crime was committed
  * _string_
* __offense occurrence day of the week named Occurrence_DayOfWeek__
  * what days of week was the crime committed (from Mon to Sun)
  * _string_
* __offense occurrence date of the month named Occurrence_DayOfMonth__
  * what date of the month was the crime committed (from 1-31)
  * _integer_
* __offense occurrence day of the year named Occurrence_DayOfYear__
  * what day of the year was the crime committed (from 1-365)
  * _integer_
* __offense occurrence hour named Occurrence_Hour__
  * what hour of the day was the crime committed (from 1-24)
  * _integer_
* __offense report date named Report_Date__
  * when the incident was reported to the authorities
  * _string_
* __offense report year named Report_Year__
  * which year was the incident reported
  * _integer_
* __offense report month named Report_Month__
  * which month was the incident reported
  * _string_
* __offense report day of the week named DayOfWeek__
  * which day of week was the incident reported (Mon - Sun)
  * _string_
* __offense report day of the month named DayOfMonth__
  * which day of the month was the incident reported (from 1-31)
  * _integer_
* __offense report day of the year named DayOfYear__
  * which day of the year was the incident reported (from 1-365)
  * _integer_
* __offense report hour named Report_Hour__
  * which hour of the day was the incident reported
  * _integer_
* __division where offense named Division__
  * the division of the location, mostly used to identify the police service responsible
  * _string_
* __city where offense where offense took place named City__
  * city name in or around Toronto
  * _string_
* __hood where offense took place named Hood_ID__
  * the hood id for all Toronto's neighborhoods (out of 158)
  * _string_
* __neighborhood where offense took place named NeighbourhoodName__
  * the neighborhood name in Toronto and surrounding areas
  * _string_
* __location where offense took place named Location_Type__
  * broad description of the crime location.
  * _string_
* __location premise of where offense took place named Premise_Type__
  * description of where bike was stolen
  * _string_
* __bike make of stolen bike named Bike_Make__
  * brand of bike that was stolen.
  * _string_
* __bike model of stolen bike named Bike_Model__
  * model of bike that was stolen.
  * _string_
* __bike type of stolen bike named Bike_Type__
  * type of bike that was stolen
  * _string_
* __bike speed of stolen bike named Bike_Speed__
  * the assumed speed of the bike
  * _integer_
* __bike color of stolen bike named Bike_Colour__
  * colour of the bike that was stolen.
  * _string_
* __cost of stolen bike named Cost_of_Bike__
  * cost of bike that was stolen.
  * _double_
* __condition of stolen bike named Status__
  * current condition of the bike (STOLEN, RECOVERED, or UNKNOWN)
  * _string_
* __coordinates of bike stolen named Geometry__
  * precise location of the crime location
  * _string_

\pagebreak
As with all the data, let us do a preliminary safety removal of any data that has NA entries.
In addition, let us print out a summary of crimes by year to see if there are any outliers.\
\
**Figure 1: Total Number of Bike Thefts Each Year**
```{r, echo=FALSE}
#omit all the entries that has NA inputs, they won't be helpful to our data
data <- na.omit(origin)
summary <- table(data$Occurrence_Year)
print(summary)
```

We can see that there are some outliers from 2009-2013. In addition, the 2022 data is not complete. Let us filter them out and obtain a complete data, the one we will be using for our report below.\
\
**Figure 2: Data After Filtering Incomplete Years**
```{r}
data = data %>% filter(Occurrence_Year >= 2014) %>%
  filter(Occurrence_Year < 2022)
summary_table = data %>% count(Occurrence_Year) %>% 
  rename(Year = Occurrence_Year, Theft_Count = n)
print(summary_table)
```
\newpage
For our first observation, let us use grouping, summarizing to create a simple plot\
\
**Figure 3: Average Cost of Stolen Bikes by Occurrence Year**
```{r}
# Calculate average cost of bike by year
avg_cost_by_year <- data %>%
  group_by(Occurrence_Year) %>%
  summarize(avg_cost = mean(Cost_of_Bike))

# Create plot of average cost of bike by year
ggplot(avg_cost_by_year, aes(x = Occurrence_Year, y = avg_cost)) +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  labs(x = "Occurrence Year", y = "Average Cost of Bike")
  #ggtitle("Average Cost of Stolen Bikes by Occurrence Year")
```
From the graph, we can observe that there was a upward trend of the bike pricing until the 2020.
This could suggest a decrease in bike quality stolen since the pandemic started.
\newpage
For our next observation, let us utilize the hour variable given to determine the high traffic time for bike thefts.\
\
**Figure 4: Number of Thefts During each Hour**
```{r}
ggplot(data = data, aes(x = Occurrence_Hour)) +
  geom_histogram(binwidth = 1, color = "black", fill = "lightblue") +
  labs(x = "Occurrence Hour", y = "Number of Thefts") 
  #ggtitle("Number of Thefts During each Hour")
```
Observing this histogram, we can see that after midnight, there is a significant decrease in thefts.
The theft occurrences spikes again after 7am before peaking at 6pm. This observation make sense as most citizens secure their bikes during nighttime, while incidents are more likely to occur during high traffic times in the morning and evening.
\pagebreak

The graph below shows the amount of bikes stolen in the first half of years 2019 and 2020.

```{r}

data2 = data %>% filter(Occurrence_Year %in% c(2019,2020,2021) & Report_DayOfYear<=182)

ggplot(data2, aes( x=Report_DayOfYear)) +
  geom_histogram(aes(fill=factor(Occurrence_Year)),alpha=0.5)+
  labs(fill="Occurrence_Year") +
  ggtitle("Bike Thefts in the first half of recent years")
```

We can deduce that a significantly higher number of bikes were stolen in the first half of 2019 than 2020.


Let's now take a sample of 1000 observations from the dataset and construct a 97% confidence interval for the proportion of bikes stolen on a Monday. Let's also construct a 97% Bootstrap confidence interval for the proportion of buildings not violating a code:

```{r}
# Confidence interval - Armaan

samp = data %>% sample_n(1000)

prop.test(x = sum(samp$Occurrence_DayOfWeek == "Monday"), n = length(samp$Occurrence_DayOfWeek), conf.level = 0.97)

# Bootstrapping

boot_function = function(){
  
  boot_data = samp  %>% sample_n(nrow(samp), replace = T)
  
  boot_prop = mean(boot_data$Occurrence_DayOfWeek == "Monday")
  
  return(boot_prop)
  
}

quantile(replicate(1000, boot_function()), c(0.1, 0.9))

```

From this, we know that ...


Now, let's create a summary table to find out the most frequent type of bike stolen (Bike_Make and Bike_Colour) in 2013

```{r}

data3 = origin %>%
  filter(Occurrence_Year == 2013) %>%
  group_by(Occurrence_Year, Bike_Make, Bike_Colour) %>%
  summarise(total = sum(n=n())) %>%
  arrange(Occurrence_Year, total)
as.data.frame(data3)
```

From the above table, we can notice that the most frequent type of bike stolen in 2013 was a CCM with color blue.

```{r}
#Aaron's Chunk 1
```


```{r}

new_table <- table(data$NeighbourhoodName)
# create data frame with neighborhood names and counts
new_df <- data.frame(nh = names(new_table), count = as.vector(new_table), hood_id = unique(data$Hood_ID[match(names(new_table), data$NeighbourhoodName)]))

new_df$hood_id <- as.numeric(new_df$hood_id)

new_df <- new_df %>% mutate(nh_groups = case_when(new_df$hood_id >= 112 ~ 'East',
                                                  (new_df$hood_id<112 & new_df$hood_id>=84) ~ 'Central',
                                                  (new_df$hood_id<84 & new_df$hood_id>=56)~'Downtown',
                                                  (new_df$hood_id<56 & new_df$hood_id>=28)~'North',
                                                  TRUE~'West'))

grouped_data <- new_df %>% 
  group_by(nh_groups) %>% 
  summarize(count = sum(count)) %>%
  mutate(percentage = percent(count / sum(count)))

# create a pie chart
ggplot(grouped_data, aes(x = "", y = count, fill = nh_groups)) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  labs(fill = "Neighborhood Groups") +
  ggtitle("Neighborhood Group Counts") +
  geom_text(aes(label = percentage), position = position_stack(vjust = 0.5)) +
  scale_y_continuous(labels = percent_format()) +
  theme_void() +
  theme(text = element_text(size = 12))

```
Let's map out the occurences of such bike thefts onto a scatterplot to visualize the span of the thefts across Toronto.

```{r}

data$longitude <- as.numeric(str_extract(data$geometry, "-?\\d+\\.\\d+"))
data$latitude <- as.numeric(str_extract_all(data$geometry, "-?\\d+\\.\\d+")[[1]][2])

data = data %>% mutate(cost_lost = case_when(Cost_of_Bike>=900~"high",
                                     (Cost_of_Bike<900 & Cost_of_Bike>=600)~"mid",
                                     TRUE ~"low"))
ggplot(data, aes(y = latitude, x = longitude, fill = data$Cost_of_Bike)) +
  geom_point(shape = 21, size = 2) +
  scale_fill_gradient2(limits = c(0, max(data$Cost_of_Bike)), low = "red", mid = "yellow",
                       high = "green", space = "Lab")

```
